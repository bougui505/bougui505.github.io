<!DOCTYPE html>
<html>

  <head>
    <link rel="icon" type="image/png" href="/favicon.ico" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>New publication: An automatic tool to analyze and cluster macromolecular conformations based on Self-Organizing Maps</title>
    <meta name="description" content="Blog of Guillaume Bouvier
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://bougui505.github.io/science/2015/01/13/new-publication-an-automatic-tool-to-analyze-and-cluster-macromolecular-conformations-based-on-self-organizing-maps.html">
</head>


  <body>

    <header class="site-header">

<!--google analytics-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55934945-1', 'auto');
  ga('send', 'pageview');
</script>

  <!--mathjax-->
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  <div class="wrapper">

    <a class="site-title" href="/">bloggb</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/bibliography.html">Bibliography</a>
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/search.html">Search</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <h1 id="new-publication-an-automatic-tool-to-analyze-and-cluster-macromolecular-conformations-based-on-self-organizing-maps">New publication: An automatic tool to analyze and cluster macromolecular conformations based on Self-Organizing Maps</h1>

<p><a href="http://dx.doi.org/10.1093/bioinformatics/btu849">Link to the online publication.</a></p>

<h2 id="abstract">Abstract:</h2>

<p><strong>Motivation</strong>: Sampling the conformational space of biological macromolecules generates large sets of data with considerable complexity.
 Data-mining techniques, such as clustering, can extract meaningful information.
 Among them, the Self-Organizing Maps (SOMs) algorithm has shown great promise, in particular since its computation time rises only linearly with the size of the data set.
 Whereas SOMs are generally used with few neurons, we investigate here their behavior with large numbers of neurons.</p>

<p><strong>Results</strong>: We present here a python library implementing the full SOM analysis workflow.
 Large SOMs can readily be applied on heavy data sets.
 Coupled with visualization tools they have very interesting properties.
 Descriptors for each conformation of a trajectory are calculated and mapped onto a 3D landscape, the U-matrix, reporting the distance between neighboring neurons.
 To delineate clusters, we developed the flooding algorithm, which hierarchically identifies local basins of the U-matrix from the global minimum to the maximum.</p>

<p><strong>Availability</strong>: The python implementation of the SOM library is freely available on <a href="https://github.com/bougui505/SOM">github</a>.</p>

<h2 id="some-technical-remarks-on-how-the-figure-has-been-generated">Some technical remarks on how the figure has been generatedâ€¦</h2>

<p><img src="/assets/umat_protein_conformations.png" alt="U-matrix" /></p>

<h3 id="compute-the-descriptors-from-the-trajectory-in-dcd-format">Compute the descriptors from the trajectory in dcd format</h3>

<p>We start from the DCD trajectory file (<code class="highlighter-rouge">traj.dcd</code>) of the folding trajectory of the G protein.
Only the <script type="math/tex">C_{\alpha}</script> atoms were kept.
This is sufficient for the conformational clustering.</p>

<p>First we create a configuration file (<code class="highlighter-rouge">makeVectorsFromdcd_PCA.conf</code>) for the python script <code class="highlighter-rouge">applications/makeVectorsFromdcd_PCA.py</code> with the following content:</p>

<ul>
  <li><code class="highlighter-rouge">nframes</code>: the number of frames</li>
  <li><code class="highlighter-rouge">structFile</code>: the pdb of your structure</li>
  <li><code class="highlighter-rouge">projection</code>: set to True</li>
  <li><code class="highlighter-rouge">nProcess</code>: the number of parallel jobs</li>
</ul>

<p>Below, the <code class="highlighter-rouge">makeVectorsFromdcd_PCA.conf</code> file:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[makeVectors]
nframes: 750000
structFile: struct.pdb
trajFile: traj.dcd
projection: True
nProcess: 2
</code></pre>
</div>

<p>Now, we can run the script:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ python makeVectorsFromdcd_PCA.py makeVectorsFromdcd_PCA.conf
</code></pre>
</div>

<p>To generate the conformational descriptors for each frame of the trajectory as described in the publication.</p>

<h3 id="learn-the-som">Learn the SOM</h3>

<p>Now we can open an interactive python session with ipython or ipython notebook, for example, and import the required python modules.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">SOM2</span>
<span class="kn">import</span> <span class="nn">SOMclust</span>
<span class="kn">import</span> <span class="nn">SOMTools</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rc</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s">'family'</span> <span class="p">:</span> <span class="s">'normal'</span><span class="p">,</span> <span class="s">'size'</span> <span class="p">:</span> <span class="mi">14</span><span class="p">}</span>
<span class="n">rc</span><span class="p">(</span><span class="s">'font'</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>
<span class="n">rc</span><span class="p">(</span><span class="s">'text'</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="o">%</span> <span class="n">pylab</span> <span class="n">inline</span> <span class="c"># if you use ipython notebook</span></code></pre></figure>

<p>Then, we load the input matrix containing the conformational descriptors.
After that we can learn the SOM with <code class="highlighter-rouge">som.learn</code>.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">inputmatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">'projections.npy'</span><span class="p">)</span>
<span class="n">som</span> <span class="o">=</span> <span class="n">SOM2</span><span class="o">.</span><span class="n">SOM</span><span class="p">(</span><span class="n">inputmatrix</span><span class="p">)</span>
<span class="n">som</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">smap</span> <span class="o">=</span> <span class="n">som</span><span class="o">.</span><span class="n">smap</span> <span class="c"># The SOM map</span>
<span class="n">numpy</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">'smap'</span><span class="p">,</span> <span class="n">smap</span><span class="p">)</span> <span class="c"># We save the SOM map (smap) as a numpy file (npy format)</span></code></pre></figure>

<h3 id="the-u-matrix">The U-matrix</h3>

<p>Now we can compute the U-matrix corresponding to the map:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">nres</span> <span class="o">=</span> <span class="n">smap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span> <span class="c"># this line give the number of residue (C alpha)</span>
<span class="n">umat1</span><span class="p">,</span> <span class="n">umat2</span><span class="p">,</span> <span class="n">umat3</span><span class="p">,</span> <span class="n">umat4</span> <span class="o">=</span> <span class="n">SOMTools</span><span class="o">.</span><span class="n">getUmatrix</span><span class="p">(</span><span class="n">smap</span><span class="p">[:,:,:</span><span class="n">nres</span><span class="p">]),</span> <span class="n">SOMTools</span><span class="o">.</span><span class="n">getUmatrix</span><span class="p">(</span><span class="n">smap</span><span class="p">[:,:,</span><span class="n">nres</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">nres</span><span class="p">]),</span> <span class="n">SOMTools</span><span class="o">.</span><span class="n">getUmatrix</span><span class="p">(</span><span class="n">smap</span><span class="p">[:,:,</span><span class="mi">2</span><span class="o">*</span><span class="n">nres</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">nres</span><span class="p">]),</span> <span class="n">SOMTools</span><span class="o">.</span><span class="n">getUmatrix</span><span class="p">(</span><span class="n">smap</span><span class="p">[:,:,</span><span class="mi">3</span><span class="o">*</span><span class="n">nres</span><span class="p">:</span><span class="mi">4</span><span class="o">*</span><span class="n">nres</span><span class="p">])</span>
<span class="n">umat</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">umat1</span><span class="p">)</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">umat2</span><span class="p">)</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">umat3</span><span class="p">)</span><span class="o">+</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">umat4</span><span class="p">))</span><span class="o">/</span><span class="n">nres</span></code></pre></figure>

<p>We decompose the U-matrix according to the four eigenvectors to compute the U-matrix in Angstrom.</p>

<h3 id="the-best-matching-units-bmus">The Best Matching Units (BMUs)</h3>

<p>The BMUs give the coordinate of each frame in the SOM map.
They allow the projection of data onto the map.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">bmus</span> <span class="o">=</span> <span class="n">som</span><span class="o">.</span><span class="n">get_allbmus_kdtree</span><span class="p">()</span></code></pre></figure>

<p>We use the k-d tree algorithm to compute the BMUs to avoid memory errors.</p>

<h3 id="the-density">The density</h3>

<p>The density gives the number of frame for each unit of the SOM map.
It is easily computed from the BMUs:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">density</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">umat</span><span class="p">)</span>
<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">bmus</span><span class="p">:</span>
    <span class="n">density</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span></code></pre></figure>

<h3 id="data-projection">Data projection</h3>

<p>In the publication we project the RMSD onto the map.
You can compute the RMSD with the program of your choice and then save the data in a text file (one column and one value per line for each frame).
This part is very flexible, you can project any property you want.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s">"data.txt"</span><span class="p">)</span>
<span class="n">projectmap</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">umat</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bmus</span><span class="p">):</span>
    <span class="n">projectmap</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">projectmap</span> <span class="o">/=</span> <span class="n">density</span> </code></pre></figure>

<h3 id="flooding-the-map">Flooding the map</h3>

<p>The SOM map has periodic boundaries.
To deal with the periodicity, the flooding algorithm is used.
See the publication for more details.
Below is the code to flood the map and unwrap it:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">clust</span> <span class="o">=</span> <span class="n">SOMclust</span><span class="o">.</span><span class="n">clusters</span><span class="p">(</span><span class="n">umat</span><span class="p">,</span> <span class="n">bmus</span><span class="p">,</span> <span class="n">smap</span><span class="p">)</span>
<span class="n">clust</span><span class="o">.</span><span class="n">getclusters</span><span class="p">()</span></code></pre></figure>

<h3 id="plot-the-u-matrix-and-projection-with-matplotlib">Plot the U-matrix and projection with matplotlib</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">im1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">clust</span><span class="o">.</span><span class="n">umat_cont</span><span class="p">,</span> <span class="n">clust</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s">"left"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s">"5</span><span class="si">%</span><span class="s">"</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">cb1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
<span class="n">cb1</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidths</span><span class="p">(</span><span class="mf">18.0</span><span class="p">)</span> <span class="c"># for the line width in the colorbar of the contour plot</span>
<span class="n">cb1</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">"Local similarity (</span><span class="err">\</span><span class="s">AA)"</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">70</span><span class="p">)</span>
<span class="n">im2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">clust</span><span class="o">.</span><span class="n">flood</span><span class="p">(</span><span class="n">projectmap</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">clust</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">PRGn</span><span class="p">)</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s">"right"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s">"5</span><span class="si">%</span><span class="s">"</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">cb2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
<span class="n">cb2</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">"PDB-structre similarity (</span><span class="err">\</span><span class="s">AA)"</span><span class="p">)</span>
<span class="n">im3</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">clust</span><span class="o">.</span><span class="n">localminima</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">clust</span><span class="o">.</span><span class="n">localminima</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'r'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">'map.pdf'</span><span class="p">)</span> </code></pre></figure>

<h3 id="sausage-representation-of-an-ensemble-of-structures-from-rmsf-values-with-pymol">Sausage representation of an ensemble of structures from rmsf values with pymol</h3>

<p>The sausage representations were obtained with pymol.</p>

<p><img src="/assets/sausage.png" alt="sausage" /></p>

<h4 id="sausagepy"><code class="highlighter-rouge">sausage.py</code></h4>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: UTF8 -*-</span>
<span class="s">"""
author: Guillaume Bouvier
email: guillaume.bouvier@ens-cachan.org
creation date: 2014 07 24
license: GNU GPL
Please feel free to use and modify this, but keep the above information.
Thanks!
"""</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">'/c5/shared/pymol/1.7.0.0-python-2.7.5-shared/lib/python2.7/site-packages/'</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">__main__</span>
<span class="c">#__main__.pymol_argv = ['pymol','-qc'] # Pymol: quiet and no GUI</span>
<span class="kn">import</span> <span class="nn">pymol</span>
<span class="n">pymol</span><span class="o">.</span><span class="n">finish_launching</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">align_all</span>
<span class="kn">import</span> <span class="nn">rmsf_states</span>

<span class="n">pdb_file_1</span> <span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">pdb_name_1</span> <span class="o">=</span><span class="n">pdb_file_1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">pdb_file_2</span> <span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">pdb_name_2</span> <span class="o">=</span><span class="n">pdb_file_2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pdb_file_1</span><span class="p">,</span> <span class="n">pdb_name_1</span><span class="p">)</span>
<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="s">"all"</span><span class="p">)</span>
<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">pdb_name_1</span><span class="p">)</span>


<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pdb_file_2</span><span class="p">,</span> <span class="n">pdb_name_2</span><span class="p">)</span>
<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="s">"all"</span><span class="p">)</span>
<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">pdb_name_2</span><span class="p">)</span>

<span class="k">print</span> <span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>

<span class="n">align_all</span><span class="o">.</span><span class="n">align_all</span><span class="p">(</span><span class="n">pdb_name_1</span><span class="p">)</span>

<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">hide</span><span class="p">(</span><span class="s">'all'</span><span class="p">)</span>
<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s">'cartoon'</span><span class="p">)</span>

<span class="n">rmsf_states</span><span class="o">.</span><span class="n">rmsf_states</span><span class="p">(</span><span class="n">pdb_name_2</span><span class="p">)</span>

<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">cartoon</span><span class="p">(</span><span class="s">'putty'</span><span class="p">)</span>
<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">spectrum</span><span class="p">(</span><span class="s">'b'</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="s">'</span><span class="si">%</span><span class="s">s and name CA'</span><span class="o">%</span><span class="n">pdb_name_2</span><span class="p">)</span>

<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">orient</span><span class="p">(</span><span class="n">pdb_name_2</span><span class="p">)</span>

<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="s">'ray_opaque_background'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"Press enter key to continue or x + enter to terminate"</span>
<span class="n">wait</span><span class="o">=</span><span class="nb">raw_input</span><span class="p">()</span>
<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">png</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">s.png"</span><span class="o">%</span><span class="p">(</span><span class="n">pdb_name_2</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">2400</span><span class="p">,</span> <span class="n">ray</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span> <span class="s">'done'</span>
<span class="n">pymol</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span></code></pre></figure>

<p>This script requires these pymol scripts:</p>

<h4 id="alignallpy"><code class="highlighter-rouge">align_all.py</code></h4>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#! /usr/bin/env python</span>
<span class="c"># original Written by Jules Jacobsen (jacobsen@ebi.ac.uk). Feel free to do whatever you like with this code.</span>
<span class="c"># extensively modified by Robert L. Campbell (rlc1@queensu.ca)</span>

<span class="kn">from</span> <span class="nn">pymol</span> <span class="kn">import</span> <span class="n">cmd</span>

<span class="k">def</span> <span class="nf">align_all</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">mobile_selection</span><span class="o">=</span><span class="s">'name ca'</span><span class="p">,</span><span class="n">target_selection</span><span class="o">=</span><span class="s">'name ca'</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">cgo_object</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="s">"""
  Aligns all models in a list to one target

  usage:
    align_all [target][target_selection=name ca][mobile_selection=name ca][cutoff=2][cycles=5][cgo_object=0]
        where target specifies the model id you want to align all others against,
        and target_selection, mobile_selection, cutoff and cycles are options
        passed to the align command.

    By default the selection is all C-alpha atoms and the cutoff is 2 and the
    number of cycles is 5.
    Setting cgo_object to 1, will cause the generation of an alignment object for
    each object.  They will be named like &lt;object&gt;_on_&lt;target&gt;, where &lt;object&gt; and
    &lt;target&gt; will be replaced by the real object and target names.

    Example:
      align_all target=name1, mobile_selection=c. b &amp; n. n+ca+c+o,target_selection=c. a &amp; n. n+ca+c+o

  """</span>
  <span class="n">cutoff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
  <span class="n">cycles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span>
  <span class="n">cgo_object</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cgo_object</span><span class="p">)</span>

  <span class="n">object_list</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>
  <span class="n">object_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

  <span class="n">rmsd</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">rmsd_list</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">object_list</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">cgo_object</span><span class="p">:</span>
      <span class="n">objectname</span> <span class="o">=</span> <span class="s">'align_</span><span class="si">%</span><span class="s">s_on_</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">object_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">target</span><span class="p">)</span>
      <span class="n">rms</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">s &amp; </span><span class="si">%</span><span class="s">s'</span><span class="o">%</span><span class="p">(</span><span class="n">object_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">mobile_selection</span><span class="p">),</span><span class="s">'</span><span class="si">%</span><span class="s">s &amp; </span><span class="si">%</span><span class="s">s'</span><span class="o">%</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">target_selection</span><span class="p">),</span><span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span><span class="n">cycles</span><span class="o">=</span><span class="n">cycles</span><span class="p">,</span><span class="nb">object</span><span class="o">=</span><span class="n">objectname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">rms</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">s &amp; </span><span class="si">%</span><span class="s">s'</span><span class="o">%</span><span class="p">(</span><span class="n">object_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">mobile_selection</span><span class="p">),</span><span class="s">'</span><span class="si">%</span><span class="s">s &amp; </span><span class="si">%</span><span class="s">s'</span><span class="o">%</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">target_selection</span><span class="p">),</span><span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span><span class="n">cycles</span><span class="o">=</span><span class="n">cycles</span><span class="p">)</span>

    <span class="n">rmsd</span><span class="p">[</span><span class="n">object_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">rmsd_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">object_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">rms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rms</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

  <span class="n">rmsd_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="nb">cmp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="c"># loop over dictionary and print out matrix of final rms values</span>
  <span class="k">print</span> <span class="s">"Aligning against:"</span><span class="p">,</span><span class="n">target</span>
  <span class="k">for</span> <span class="n">object_name</span> <span class="ow">in</span> <span class="n">object_list</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"</span><span class="si">%</span><span class="s">s: </span><span class="si">%6.3</span><span class="s">f using </span><span class="si">%</span><span class="s">d atoms"</span> <span class="o">%</span> <span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="n">rmsd</span><span class="p">[</span><span class="n">object_name</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">rmsd</span><span class="p">[</span><span class="n">object_name</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

  <span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">Sorted from best match to worst:"</span>
  <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rmsd_list</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"</span><span class="si">%</span><span class="s">s: </span><span class="si">%6.3</span><span class="s">f using </span><span class="si">%</span><span class="s">d atoms"</span> <span class="o">%</span> <span class="n">r</span>

<span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s">'align_all'</span><span class="p">,</span><span class="n">align_all</span><span class="p">)</span></code></pre></figure>

<h4 id="rmsfstatespy"><code class="highlighter-rouge">rmsf_states.py</code></h4>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#! /usr/bin/python</span>
<span class="c"># Copyright (c) 2009 Robert L. Campbell (rlc1@queensu.ca)</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span><span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pymol</span> <span class="kn">import</span> <span class="n">cmd</span>
<span class="kn">from</span> <span class="nn">pymol</span> <span class="kn">import</span> <span class="n">stored</span>

<span class="k">def</span> <span class="nf">distx2</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">):</span>
  <span class="s">"""
  Calculate the square of the distance between two coordinates.
  Returns a float
  """</span>
  <span class="n">distx2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">x2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
  <span class="k">return</span> <span class="n">distx2</span>


<span class="k">def</span> <span class="nf">rmsf_states</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span><span class="n">byres</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">reference_state</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
  <span class="s">"""
  AUTHOR

    Robert L. Campbell

  USAGE

    rmsf_states selection [,byres=0], [reference_state=1]

    Calculate the RMS fluctuation for each residue in a set of models 
    (within a multi-state object).

    If you specify byres=1, then it will only calculate the RMSF for alpha-carbons (i.e.
    it modifies the selection by adding "and name CA"), but will modify the B-factors for 
    all atoms in each residue to be the same as the alpha-carbons.

    If you use a selection that only includes only some atoms, only those atoms will have
    their B-factors modified (even with byres=1 specified).

    By default, the RMSF is calculated with respect to the first state, but you can
    change this by specifying setting reference_state to the number of another state.
  """</span>

<span class="c"># setting byres to true only makes sense if the selection is only for the alpha-carbons</span>
  <span class="n">byres</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">byres</span><span class="p">)</span>
  <span class="n">reference_state</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reference_state</span><span class="p">)</span>

<span class="c"># initialize the arrays used</span>
  <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">coord_array</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">chain</span><span class="o">=</span><span class="p">[]</span>
  <span class="n">resi</span><span class="o">=</span><span class="p">[]</span>
  <span class="n">resn</span><span class="o">=</span><span class="p">[]</span>
  <span class="n">name</span><span class="o">=</span><span class="p">[]</span>

  <span class="n">num_states</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">count_states</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>

<span class="c"># get models into models array</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_states</span><span class="p">):</span>
    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span><span class="n">state</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

<span class="c"># extract coordinates and atom identification information out of the models</span>
<span class="c"># loop over the states</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_states</span><span class="p">):</span>
    <span class="n">coord_array</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
    <span class="n">chain</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
    <span class="n">resi</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
    <span class="n">resn</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
    <span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

    <span class="k">if</span> <span class="n">byres</span><span class="p">:</span>
<span class="c"># loop over the atoms in each state</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atom</span><span class="p">)):</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atom</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">'CA'</span><span class="p">:</span>
          <span class="n">coord_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">coord</span><span class="p">)</span>
          <span class="n">chain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span>
          <span class="n">resi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">resi</span><span class="p">)</span>
          <span class="n">resn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">resn</span><span class="p">)</span>
          <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
<span class="c"># loop over the atoms in each state</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atom</span><span class="p">)):</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atom</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">coord_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">coord</span><span class="p">)</span>
        <span class="n">chain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span>
        <span class="n">resi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">resi</span><span class="p">)</span>
        <span class="n">resn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">resn</span><span class="p">)</span>
        <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="c"># initialize array</span>
  <span class="n">diff2</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c"># calculate the square of the fluctuation</span>
<span class="c"># = the sum of the distance between the atoms in each state from the reference state, squared</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">diff2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_states</span><span class="p">):</span>

<span class="c"># reference_state is 1-based, but coord_array is zero-based, so subtract 1 from </span>
<span class="c"># reference_state to get the correct reference_state</span>
      <span class="n">diff2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">distx2</span><span class="p">(</span><span class="n">coord_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">coord_array</span><span class="p">[</span><span class="n">reference_state</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>

<span class="c"># divide the fluctuation squared by the number of states and take the square root of that to get the RMSF</span>
    <span class="n">diff2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">diff2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">num_states</span><span class="p">)</span>

<span class="c"># reset all the B-factors to zero</span>
  <span class="n">cmd</span><span class="o">.</span><span class="n">alter</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span><span class="s">"b=0"</span><span class="p">)</span>

  <span class="n">b_dict</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="n">sum_rmsf</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c"># if byres, alter all B-factors in a residue to be the same</span>
  <span class="k">if</span> <span class="n">byres</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">b_lookup</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">resi</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">b_dict</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">resi</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s">''</span><span class="p">][</span><span class="n">resi</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">b</span>
    <span class="n">stored</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b_lookup</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">diff2</span><span class="p">)):</span>
      <span class="n">sum_rmsf</span> <span class="o">+=</span> <span class="n">diff2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">b_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">{})[</span><span class="n">resi</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">diff2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">mean_rmsf</span> <span class="o">=</span> <span class="n">sum_rmsf</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">diff2</span><span class="p">)</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">alter</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span><span class="s">'</span><span class="si">%</span><span class="s">s=stored.b(chain,resi,name)'</span> <span class="o">%</span> <span class="p">(</span><span class="s">'b'</span><span class="p">))</span>

<span class="c"># if not byres, alter all B-factors individually according to the RMSF for each atom</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">quiet</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">def</span> <span class="nf">b_lookup</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">resi</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">b_dict</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">resi</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b_dict</span><span class="p">[</span><span class="s">''</span><span class="p">][</span><span class="n">resi</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">b</span>
    <span class="n">stored</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b_lookup</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">diff2</span><span class="p">)):</span>
      <span class="n">sum_rmsf</span> <span class="o">+=</span> <span class="n">diff2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">b_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">resi</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">{})[</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">diff2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">chain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">resi</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">alter</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span><span class="s">'</span><span class="si">%</span><span class="s">s=stored.b(chain,resi,name)'</span> <span class="o">%</span> <span class="p">(</span><span class="s">'b'</span><span class="p">))</span>
    <span class="n">mean_rmsf</span> <span class="o">=</span> <span class="n">sum_rmsf</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">diff2</span><span class="p">)</span>

  <span class="k">print</span> <span class="s">"Mean RMSF for selection: </span><span class="si">%</span><span class="s">s = </span><span class="si">%</span><span class="s">g"</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">mean_rmsf</span><span class="p">)</span>

<span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s">"rmsf_states"</span><span class="p">,</span><span class="n">rmsf_states</span><span class="p">)</span></code></pre></figure>


        <mark>If you want to ask me a question or leave me a message add @bougui505 in your comment.</mark>

<script src="https://apis.google.com/js/plusone.js"></script>
  
  <div class="g-comments"
      data-href="http://bougui505.github.io/science/2015/01/13/new-publication-an-automatic-tool-to-analyze-and-cluster-macromolecular-conformations-based-on-self-organizing-maps.html"
      data-width="642"
      data-first_party_property="BLOGGER"
      data-view_type="FILTERED_POSTMOD">
  </div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <a href="http://stackexchange.com/users/1853608/bougui"><img src="http://stackexchange.com/users/flair/1853608.png" width="208" height="58" alt="profile for bougui on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for bougui on Stack Exchange, a network of free, community-driven Q&amp;A sites" /></a>

    <h2 class="footer-heading">bloggb</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>bloggb</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/bougui505">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">bougui505</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/bougui505">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">bougui505</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Blog of Guillaume Bouvier
</p>
        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work by <a xmlns:cc="http://creativecommons.org/ns#" href="http://izar.crabdance.com/" property="cc:attributionName" rel="cc:attributionURL">Guillaume Bouvier</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
      </div>
    </div>

  </div>

</footer>


  </body>


</html>
