<!DOCTYPE html>
<html>

  <head>
    <link rel="icon" type="image/png" href="/favicon.ico" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Smoothed data histogram with SOM</title>
    <meta name="description" content="Blog of Guillaume Bouvier
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://bougui505.github.io/science/2014/10/24/smoothed-data-histogram-with-som.html">
</head>


  <body>

    <header class="site-header">

<!--google analytics-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55934945-1', 'auto');
  ga('send', 'pageview');
</script>

  <!--mathjax-->
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  <div class="wrapper">

    <a class="site-title" href="/">bloggb</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/bibliography.html">Bibliography</a>
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/search.html">Search</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <h1 id="smoothed-data-histogram-with-som">Smoothed data histogram with SOM</h1>

<p>I played a lot with Self-Organizing Map (<strong>SOM</strong>). The 2D SOM distributes the
input vectors onto a 2D plane. Mathematically the SOM is a 3D matrix and the
length of the third dimension is given by the length of your input data. To
visualize the SOM itâ€™s usual to compute the Unified distance matrix
(<strong>U-matrix</strong>). The U-matrix gives for each neuron of the SOM the mean Euclidean
distance between the considered neuron and its neighbors.</p>

<p><img src="/assets/smooth_data_histograms_files/smooth_data_histograms_1_0.png" alt="png" /></p>

<p>Another way to visualize the SOM is to count the number of input data in each
bin of the SOM. However the SOM algorithm try to sparse data homogeneously
within the map. The basic idea here is to smooth the histogram of the SOM. To
do this each input data is not attributed to a unique cell but to an ensemble
    of cells. The number of cells in the ensemble is determined by the
    smoothing parameter <script type="math/tex">s</script>. This idea come from this document: <a href="http://www.ifs.tuwien.ac.at/ifs/research/pub_pdf/pam_icann02.pdf">Using Smoothed Data Histograms for Cluster Visualization in Self-Organizing Maps</a>.</p>

<p>The ipython notebook import:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">pylab</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">'/Bis/home/bougui/bin/SOM'</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">SOM2</span>
<span class="kn">import</span> <span class="nn">SOMclust</span>
<span class="kn">import</span> <span class="nn">scipy.spatial.distance</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span><span class="mi">6</span></code></pre></figure>

<p>A 2D potential constructed from 4 randomly chosen points.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">E</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),(</span><span class="mi">30</span><span class="p">,</span><span class="mi">40</span><span class="p">),(</span><span class="mi">40</span><span class="p">,</span><span class="mi">10</span><span class="p">),(</span><span class="mi">10</span><span class="p">,</span><span class="mi">40</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
    <span class="n">E</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
<span class="n">matshow</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">colorbar</span><span class="p">()</span></code></pre></figure>

<p><img src="/assets/smooth_data_histograms_files/smooth_data_histograms_5_0.png" alt="png" /></p>

<p>This potential is then sampled using a Monte-Carlo</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">montecarlo</span><span class="p">(</span><span class="n">potential</span><span class="o">=</span><span class="n">E</span><span class="p">,</span> <span class="n">nstep</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">markov</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
    <span class="n">nx</span><span class="p">,</span><span class="n">ny</span> <span class="o">=</span> <span class="n">potential</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">pos_prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ny</span><span class="p">))</span>
    <span class="n">traj</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nstep</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">markov</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos_prev</span> <span class="o">+</span> <span class="n">asarray</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])]))</span><span class="o">%</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ny</span><span class="p">))</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">pos_prev</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pos_prev</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">potential</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="n">potential</span><span class="p">[</span><span class="n">pos_prev</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#print p(delta)</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">():</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">pos_prev</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos_prev</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos_prev</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="n">traj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">asarray</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>

<span class="n">nstep</span><span class="o">=</span><span class="mi">50000</span>
<span class="n">traj</span> <span class="o">=</span> <span class="n">montecarlo</span><span class="p">(</span><span class="n">nstep</span><span class="o">=</span><span class="n">nstep</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">markov</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">density</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">traj</span><span class="p">:</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">density</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></code></pre></figure>

<p>And then we plot the distributions obtained from the MCMC:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">matshow</span><span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="n">nstep</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">colorbar</span><span class="p">()</span></code></pre></figure>

<p><img src="/assets/smooth_data_histograms_files/smooth_data_histograms_11_0.png" alt="png" /></p>

<p>A Self-organizing map is trained with the MCMC sampling:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">som</span> <span class="o">=</span> <span class="n">SOM2</span><span class="o">.</span><span class="n">SOM</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">som</span><span class="o">.</span><span class="n">learn</span><span class="p">()</span></code></pre></figure>

<p>The resulting U-matrix.</p>

<p>(Here I used a algorithm to unwrap the U-matrix as the SOM is chosen with
periodic boundaries. The visualization is simpler with this representation.)</p>

<p>The gray scale dots are the original density of the data in the SOM space.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">umat</span> <span class="o">=</span> <span class="n">som</span><span class="o">.</span><span class="n">umatrix</span><span class="p">()</span>

<span class="n">som_density</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">som</span><span class="o">.</span><span class="n">smap</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">bmus</span> <span class="o">=</span> <span class="n">som</span><span class="o">.</span><span class="n">get_allbmus</span><span class="p">()</span>
<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">bmus</span><span class="p">:</span>
    <span class="n">som_density</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">+=</span><span class="mi">1</span>

<span class="n">clust</span> <span class="o">=</span> <span class="n">SOMclust</span><span class="o">.</span><span class="n">clusters</span><span class="p">(</span><span class="n">umat</span><span class="p">,</span> <span class="n">bmus</span><span class="p">,</span> <span class="n">som</span><span class="o">.</span><span class="n">smap</span><span class="p">)</span>

<span class="n">contour</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">clust</span><span class="o">.</span><span class="n">umat_cont</span><span class="p">,</span> <span class="n">clust</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span> <span class="mi">20</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">density_cont</span> <span class="o">=</span> <span class="n">clust</span><span class="o">.</span><span class="n">flood</span><span class="p">(</span><span class="n">som_density</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">density_cont</span><span class="p">,</span> <span class="n">clust</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">gray_r</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span></code></pre></figure>

<p><img src="/assets/smooth_data_histograms_files/smooth_data_histograms_18_0.png" alt="png" /></p>

<p>And the U-matrix in the input space in comparison with the 2D histogram of the
input data:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">subplot</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">umat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">scatter</span><span class="p">(</span><span class="n">som</span><span class="o">.</span><span class="n">smap</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">c</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">som</span><span class="o">.</span><span class="n">smap</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">c</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> 
        <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'s'</span><span class="p">)</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">input_dist</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">meshgrid</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2500</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">scatter</span><span class="p">(</span><span class="n">input_dist</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_dist</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">density</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">gray_r</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'s'</span><span class="p">)</span></code></pre></figure>

<p><img src="/assets/smooth_data_histograms_files/smooth_data_histograms_20_1.png" alt="png" /></p>

<p>Now we compute the smooth data histogram (SDH).
The membership degree is <script type="math/tex">s/c_{s}</script> to the closest bin, <script type="math/tex">(s-1)/c_{s}</script> to the second, <script type="math/tex">(s-2)/c_{s}</script> to the third and so forth.
The membership to all but the closest <script type="math/tex">s</script> bins is 0.
<script type="math/tex">c_{s}</script> is defined as: <script type="math/tex">c_{s}=\sum_{i=0}^{s-1}s-i</script></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">sdh</span><span class="p">(</span><span class="n">smap</span><span class="p">,</span> <span class="n">inputmat</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="s">"""
    return the smooth data histogram of the SOM density
    """</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">smap</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sdhmat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">)</span>
    <span class="n">dmat</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">inputmat</span><span class="p">,</span> <span class="n">smap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="c">#hmat = dmat.argsort(axis=1)[:,:s] # hit matrix</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">dmat</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">ds</span><span class="p">)[:</span><span class="n">s</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="n">sdhmat</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
    <span class="n">sdhmat</span> <span class="o">=</span> <span class="n">sdhmat</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sdhmat</span></code></pre></figure>

<p>For large dataset you can run out of memory when you compute the full distance matrix <code class="highlighter-rouge">dmat</code> with <code class="highlighter-rouge">scipy.spatial.distance.cdist(inputmat, smap.reshape(x*y,n))</code>.
Instead of computing <code class="highlighter-rouge">dmat</code> you can use <a href="http://docs.scipy.org/doc/scipy-0.13.0/reference/generated/scipy.spatial.KDTree.html">KDTree</a> or <a href="http://docs.scipy.org/doc/scipy-0.13.0/reference/generated/scipy.spatial.cKDTree.html">cKDTree</a>.
This class provides an index into a set of k-dimensional points which can be used to rapidly look up the nearest neighbors of any point.
In the function below Iâ€™ve also added the data parameter to project a weighted sum of the data with the rule exposed before.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">sdh</span><span class="p">(</span><span class="n">smap</span><span class="p">,</span> <span class="n">inputmat</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s">"""
    Return the smooth data histogram of the SOM density.
    If data is not None return the smoothed projection of the data onto the map
    """</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">smap</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sdhmat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">)</span>
    <span class="n">kdtree</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">smap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">())</span>
    <span class="n">ds</span><span class="p">,</span><span class="n">ls</span> <span class="o">=</span> <span class="n">kdtree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">inputmat</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">sdhmat</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sdhmat</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">c</span>
    <span class="n">sdhmat</span> <span class="o">=</span> <span class="n">sdhmat</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sdhmat</span></code></pre></figure>

<p>Iâ€™ve slightly changed the function to apply a distance cutoff
<code class="highlighter-rouge">distances_threshold</code> instead of a cutoff on the number of bins (<script type="math/tex">s</script>):</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">sdh</span><span class="p">(</span><span class="n">smap</span><span class="p">,</span> <span class="n">inputmat</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">distances_threshold</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s">"""
    Return the smooth data histogram of the SOM density.
    If data is not None return the smoothed projection of the data onto the map
    If distances_threshold is not none apply a distance cutoff instead of a fix number of cells
    """</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">smap</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sdhmat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">)</span>
    <span class="n">kdtree</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">smap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">distances_threshold</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ds</span><span class="p">,</span><span class="n">ls</span> <span class="o">=</span> <span class="n">kdtree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">inputmat</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">s</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">sdhmat</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sdhmat</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">c</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputmat</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">kdtree</span><span class="o">.</span><span class="n">query_ball_point</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">distances_threshold</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">sdhmat</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sdhmat</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">c</span>
    <span class="n">sdhmat</span> <span class="o">=</span> <span class="n">sdhmat</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sdhmat</span></code></pre></figure>

<p>And we choose a smoothing parameter <code class="highlighter-rouge">s</code> of 16</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sdhmat</span> <span class="o">=</span> <span class="n">sdh</span><span class="p">(</span><span class="n">som</span><span class="o">.</span><span class="n">smap</span><span class="p">,</span><span class="n">traj</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span></code></pre></figure>

<p>We compare below the original density and the smoothed density:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">density_cont</span><span class="p">,</span> <span class="n">clust</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">gray_r</span><span class="p">)</span>
<span class="n">contour</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">clust</span><span class="o">.</span><span class="n">umat_cont</span><span class="p">,</span> <span class="n">clust</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s">'Density'</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">sdhmat_cont</span> <span class="o">=</span> <span class="n">clust</span><span class="o">.</span><span class="n">flood</span><span class="p">(</span><span class="n">sdhmat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">sdhmat_cont</span><span class="p">,</span> <span class="n">clust</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">)</span>
<span class="n">contour</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">clust</span><span class="o">.</span><span class="n">umat_cont</span><span class="p">,</span> <span class="n">clust</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s">'Smoothed density'</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span></code></pre></figure>

<p><img src="/assets/smooth_data_histograms_files/smooth_data_histograms_26_0.png" alt="png" /></p>


        <mark>If you want to ask me a question or leave me a message add @bougui505 in your comment.</mark>

<script src="https://apis.google.com/js/plusone.js"></script>
  
  <div class="g-comments"
      data-href="http://bougui505.github.io/science/2014/10/24/smoothed-data-histogram-with-som.html"
      data-width="642"
      data-first_party_property="BLOGGER"
      data-view_type="FILTERED_POSTMOD">
  </div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <a href="http://stackexchange.com/users/1853608/bougui"><img src="http://stackexchange.com/users/flair/1853608.png" width="208" height="58" alt="profile for bougui on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for bougui on Stack Exchange, a network of free, community-driven Q&amp;A sites" /></a>

    <h2 class="footer-heading">bloggb</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>bloggb</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/bougui505">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">bougui505</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/bougui505">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">bougui505</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Blog of Guillaume Bouvier
</p>
        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work by <a xmlns:cc="http://creativecommons.org/ns#" href="http://izar.crabdance.com/" property="cc:attributionName" rel="cc:attributionURL">Guillaume Bouvier</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
      </div>
    </div>

  </div>

</footer>


  </body>


</html>
